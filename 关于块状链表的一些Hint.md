# 关于块状链表的一些Hint

---

## 前言——关于文件读写

`BookStore`需要支持关闭程序后重新运行仍然保留之前的数据，因此我们需要把书、用户等信息写入一个文件来保存。

由于`ASCII`文件的修改时间复杂度太高[^注1]，这里需要用到二进制文件读写的相关内容，如果大家不太记得了建议先去复习一下。

在这里推荐大家先去看（或者自己写一下）翁阿姨10-16章ppt P342开始的**图书馆的书目管理系统**例题，有助于大家理解`seekp`、`read`等函数的使用方法及机制。





## 块状链表是什么

这里可以参考oi wiki的解释：

https://oi-wiki.org/ds/block-list/

如同网址中所说，在`BookStore`中我们也仅需实现`sqrt(n)`为定值的情况。





## 块状链表的用途

`BookStore`中，我们需要利用块状链表维护一个**由`key`值到`offset`的索引**。

具体地说，以`BookStore`中我们需要管理的`Book`类为例，我们在`show`等指令中需要由一本书的`ISBN`来获得一本书的全部信息。一个简单的方法是去遍历书的存储文件，一个一个与`ISBN`比较，最后就可以找到所有的信息；但这样做显然时间复杂度太高（`o(n)`），因此我们需要用块状链表实现这样的匹配[^具体匹配方法见下文]。这样的提供`key`，返回一本书在数据储存文件里的具体地址`offset`的过程便称之为**索引**。

说得更直白一些，我们需要利用块状链表在`o(sqrt(n))`的时间复杂度下实现以下功能：

* 提供一个`key`，返回一个或多个该key值对应的`offset`值。

为了做到这一点，还需要实现以下两个功能：

* 提供一个`key`与其对应的`offset`，在块状链表中添加该元素；

* 提供一个`key`与其对应的`offset`，在块状链表中删除该元素。

这三个功能便是块状链表类对外的三个接口：`addElement`、`findElement`、`deleteElement`。

在块状链表中，应该**维护key的升序（或降序）**。





## 块状链表的组成

就我个人的写法而言，块状链表由三个类组成：`Element`、`Block`、`UnrolledLinkedList`。



### Element类

* 即索引的个体，存放一个key与其对应的offset，且重载小于号用于寻找元素位置。功能类似于`std::pair`。
* 在整个块状链表中应维护key的升序[^原因见下文中块状链表的匹配方法]。



### Block类

* 块状链表中的一个块，整个块状链表就是由若干个块组成的一个链表
* 一个Block中存放以下元素：
    * 下一个块与上一个块在文件中的地址[^可类比双向链表的指向上一个节点和下一个节点的指针]（不存在则为-1）
    * 一个`Element`类的数组，其中元素为按key升序[^原因见下文中块状链表的匹配方法]
    * 目前数组中的元素个数



### UnrolledLinkedList类

* 负责实现三个对外接口：`addElement`、`findElement`、`deleteElement`
* 块状链表类的文件即为若干个Block类的线性排列，实现一个文件系统中的链表
* 第一个块（首块）默认保存在文件的开头
* 内部需要实现两个函数：
  * `splitBlock`：当一个块元素数量较多时，将其分裂为两个块

  * `mergeBlock`：当两个块元素数量均较少时，将其合并为一个块





## 块状链表进行索引的原理

下面简要介绍块状链表进行匹配的算法（以升序为例，将每个块的数组第一个元素称为这个块的首元素[^只是个人为了方便描述的说法]）：

（注：以下算法均未考虑特殊情况，大于/小于有可能是大于等于/小于等于）

假设我们现在有一个需要进行索引的`key`。

首先访问首块，将首块的首元素与key相比较，如果小于key则访问下一个块的首元素，直到首元素大于key为止。现在我们找到了第一个首元素大于key的块，而这个块的上一个块首元素小于`key`，那么可以确定要寻找的`key`应该在上一个块的内部。

接下来在上一个块的内部进行二分查找，便可以确定元素的位置，将该元素对应的`offset`读出即可。





## 注1

`ASCII`文件在文件中**直接以字符格式**存储对应的信息，同一类型的数据如果作为字符显示会出现长度不同的现象，在修改`ASCII`文件时就会出现需要将文件整体后移的情况。

举例来说，如果你使用`ASCII`文件存储了以下信息：

```c++
9787532736553 The_Man_Who_Changed_China Robert_Lawrence_Kuhn China|Jiang 59.00 1926
```

接下来你想将`price`改为`817.00`元，由于原来存放`price`的位置只有五个字符，为了存下修正后的六个字符，就需要把后面的字符集体向后移一位。这样频繁操作时间复杂度会很高，并且也不易程序实现。

而二进制文件则没有这个问题，直接修改对应的`double`的8个byte就可以了。只要是在`double`范围内的都可以存下。











*written by: Rainy Memory*